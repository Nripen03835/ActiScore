{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Facial Emotion Analysis</h1>
    <div>
        <button class="btn btn-outline-primary me-2" id="download-report">
            <i class="fas fa-download me-2"></i>Download Report
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Video Feed</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="play-pause">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="restart">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="video-container">
                    {% if analysis.file_path %}
                    <video id="video-player" class="w-100" controls>
                        <source src="{{ url_for('static', filename=analysis.file_path) }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    {% else %}
                    <div class="webcam-container">
                        <video id="webcam" class="w-100" autoplay muted></video>
                        <canvas id="canvas-overlay" class="canvas-overlay"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" id="start-webcam">
                            <i class="fas fa-video me-2"></i>Start Webcam
                        </button>
                        <button class="btn btn-danger d-none" id="stop-webcam">
                            <i class="fas fa-stop me-2"></i>Stop
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Emotion Timeline</h5>
            </div>
            <div class="card-body">
                <canvas id="emotion-timeline"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Analysis Details</h5>
            </div>
            <div class="card-body">
                <h6 class="card-title">{{ analysis.title }}</h6>
                <p class="text-muted">{{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                
                {% if analysis.description %}
                <p>{{ analysis.description }}</p>
                {% endif %}
                
                <hr>
                
                <h6>Current Emotion</h6>
                <div class="current-emotion mb-3">
                    <div class="d-flex align-items-center">
                        <div class="emotion-icon me-3">
                            <i class="fas fa-face-smile fa-3x text-success"></i>
                        </div>
                        <div>
                            <h4 class="mb-0" id="primary-emotion">Happy</h4>
                            <div class="text-muted" id="emotion-confidence">Confidence: 85%</div>
                        </div>
                    </div>
                </div>
                
                <h6>Emotion Distribution</h6>
                <canvas id="emotion-chart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Facial Landmarks</h5>
            </div>
            <div class="card-body">
                <div class="landmarks-container">
                    <canvas id="landmarks-canvas" width="300" height="300"></canvas>
                </div>
                
                <div class="mt-3">
                    <h6>Detected Features</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Eye Openness
                            <span class="badge bg-primary rounded-pill">85%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Mouth Openness
                            <span class="badge bg-primary rounded-pill">40%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Eyebrow Position
                            <span class="badge bg-primary rounded-pill">Normal</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Emotion Chart
        const emotionCtx = document.getElementById('emotion-chart').getContext('2d');
        const emotionChart = new Chart(emotionCtx, {
            type: 'bar',
            data: {
                labels: ['Happy', 'Sad', 'Angry', 'Surprised', 'Neutral', 'Fear', 'Disgust'],
                datasets: [{
                    label: 'Confidence',
                    data: [85, 5, 2, 3, 3, 1, 1],
                    backgroundColor: [
                        '#4CAF50', '#2196F3', '#F44336', '#FFC107', '#9E9E9E', '#673AB7', '#FF5722'
                    ]
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Emotion Timeline Chart
        const timelineCtx = document.getElementById('emotion-timeline').getContext('2d');
        const timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: 20}, (_, i) => i + 's'),
                datasets: [
                    {
                        label: 'Happy',
                        data: [10, 20, 30, 40, 60, 85, 80, 75, 70, 65, 60, 55, 50, 45, 40, 35, 30, 25, 20, 15],
                        borderColor: '#4CAF50',
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Sad',
                        data: [5, 10, 15, 20, 15, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75],
                        borderColor: '#2196F3',
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Angry',
                        data: [2, 5, 8, 10, 5, 2, 3, 4, 5, 4, 3, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                        borderColor: '#F44336',
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Draw facial landmarks
        const landmarksCanvas = document.getElementById('landmarks-canvas');
        const landmarksCtx = landmarksCanvas.getContext('2d');
        
        // Draw a sample face
        landmarksCtx.fillStyle = '#f0f0f0';
        landmarksCtx.beginPath();
        landmarksCtx.ellipse(150, 150, 100, 130, 0, 0, 2 * Math.PI);
        landmarksCtx.fill();
        
        // Draw eyes
        landmarksCtx.fillStyle = '#333';
        landmarksCtx.beginPath();
        landmarksCtx.ellipse(120, 120, 10, 15, 0, 0, 2 * Math.PI);
        landmarksCtx.fill();
        
        landmarksCtx.beginPath();
        landmarksCtx.ellipse(180, 120, 10, 15, 0, 0, 2 * Math.PI);
        landmarksCtx.fill();
        
        // Draw mouth (happy)
        landmarksCtx.strokeStyle = '#333';
        landmarksCtx.lineWidth = 3;
        landmarksCtx.beginPath();
        landmarksCtx.arc(150, 170, 30, 0.1 * Math.PI, 0.9 * Math.PI, false);
        landmarksCtx.stroke();
        
        // Draw landmarks
        landmarksCtx.fillStyle = '#FF5722';
        const landmarks = [
            [100, 100], [120, 90], [150, 85], [180, 90], [200, 100], // Eyebrows
            [110, 120], [120, 120], [130, 120], // Left eye
            [170, 120], [180, 120], [190, 120], // Right eye
            [150, 140], // Nose
            [120, 170], [150, 180], [180, 170] // Mouth
        ];
        
        landmarks.forEach(point => {
            landmarksCtx.beginPath();
            landmarksCtx.arc(point[0], point[1], 3, 0, 2 * Math.PI);
            landmarksCtx.fill();
        });
        
        // Webcam functionality
        const startWebcamBtn = document.getElementById('start-webcam');
        const stopWebcamBtn = document.getElementById('stop-webcam');
        const webcamVideo = document.getElementById('webcam');
        const canvasOverlay = document.getElementById('canvas-overlay');
        
        if (startWebcamBtn) {
            startWebcamBtn.addEventListener('click', function() {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        webcamVideo.srcObject = stream;
                        startWebcamBtn.classList.add('d-none');
                        stopWebcamBtn.classList.remove('d-none');
                        
                        // Start facial analysis
                        startFacialAnalysis();
                    })
                    .catch(function(err) {
                        console.error('Error accessing webcam:', err);
                        alert('Error accessing webcam. Please check permissions.');
                    });
            });
        }
        
        if (stopWebcamBtn) {
            stopWebcamBtn.addEventListener('click', function() {
                if (webcamVideo.srcObject) {
                    webcamVideo.srcObject.getTracks().forEach(track => track.stop());
                    webcamVideo.srcObject = null;
                    startWebcamBtn.classList.remove('d-none');
                    stopWebcamBtn.classList.add('d-none');
                }
            });
        }
        
        function startFacialAnalysis() {
            // This would connect to the backend for real-time analysis
            console.log('Starting facial analysis...');
            
            // Simulate real-time updates
            setInterval(function() {
                updateEmotionData();
            }, 1000);
        }
        
        function updateEmotionData() {
            // Simulate changing emotion data
            const emotions = ['Happy', 'Sad', 'Angry', 'Surprised', 'Neutral', 'Fear', 'Disgust'];
            const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            const confidence = Math.floor(Math.random() * 30) + 70; // 70-99%
            
            document.getElementById('primary-emotion').textContent = randomEmotion;
            document.getElementById('emotion-confidence').textContent = `Confidence: ${confidence}%`;
            
            // Update chart data
            const newData = emotions.map(() => Math.floor(Math.random() * 20));
            newData[emotions.indexOf(randomEmotion)] = confidence;
            
            emotionChart.data.datasets[0].data = newData;
            emotionChart.update();
            
            // Update timeline
            const lastTimelineData = timelineChart.data.datasets.map(dataset => {
                const data = [...dataset.data];
                data.shift();
                data.push(Math.floor(Math.random() * 100));
                return data;
            });
            
            timelineChart.data.datasets.forEach((dataset, i) => {
                dataset.data = lastTimelineData[i];
            });
            timelineChart.update();
        }
        
        // Download report functionality
        document.getElementById('download-report').addEventListener('click', function() {
            alert('Generating PDF report... This feature will be implemented in the final version.');
        });
    });
</script>
{% endblock %}